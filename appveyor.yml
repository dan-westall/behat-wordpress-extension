version: '{branch}.{build}'
platform: x86
clone_folder: c:\projects\behat
build: off
skip_tags: true

services:
  - mysql
  - iis

branches:
  except:
    - gh-pages

cache:
  - c:\tools\php -> appveyor.yml
  - '%LOCALAPPDATA%\Composer\files'

init:
  - ps:
  - SET PATH=%systemroot%\system32\inetsrv\;C:\Program Files\OpenSSL;c:\tools\php;%PATH%
  - SET COMPOSER_NO_INTERACTION=1
  - SET PHP=1
  - SET ANSICON=121x90 (121x90)
  - git config --global core.autocrlf input

install:
  # OpenSSL and PHP.
  - IF EXIST c:\tools\php (SET PHP=0)
  - IF %PHP%==1 cinst -y OpenSSL.Light
  - IF %PHP%==1 cinst -y php --allow-empty-checksums --version 7.0.9
  - cd c:\tools\php
  - IF %PHP%==1 echo @php %%~dp0composer.phar %%* > composer.bat
  - appveyor DownloadFile https://getcomposer.org/composer.phar
  - IF %PHP%==1 copy php.ini-production php.ini /Y
  - IF %PHP%==1 echo date.timezone="UTC" >> php.ini
  - IF %PHP%==1 echo extension_dir=ext >> php.ini
  - IF %PHP%==1 echo extension=php_openssl.dll >> php.ini
  - IF %PHP%==1 echo extension=php_mbstring.dll >> php.ini
  - IF %PHP%==1 echo extension=php_fileinfo.dll >> php.ini
  - IF %PHP%==1 echo extension=php_curl.dll >> php.ini

  # Install WordHat.
  - cd c:\projects\behat
  - composer install --no-interaction --prefer-dist --no-progress

  # WordPress.
  - mkdir c:\projects\wordpress
  - vendor\bin\wp core download --force --version=latest --path=c:\projects\wordpress
  - del c:\projects\wordpress\wp-config.php
  - vendor\bin\wp core config --path=c:\projects\wordpress --dbname=wordpress --dbuser=root --dbpass=Password12 --dbhost=127.0.0.1
  - vendor\bin\wp db create --path=c:\projects\wordpress
  - vendor\bin\wp core install --path=c:\projects\wordpress --url="wordpress.dev" --title="wordpress.dev" --admin_user="admin" --admin_password="password" --admin_email="admin@example.com"

  # IIS.
  - NET START W3SVC
  - choco install -y urlrewrite
  - powershell -command "New-WebSite -Name 'WordPress' -PhysicalPath 'c:\projects\wordpress' -Force"
  - echo 127.0.0.1 wordpress.dev >> %WINDIR%\System32\Drivers\Etc\Hosts
  - powershell -command "Import-Module WebAdministration; Set-ItemProperty 'IIS:\Sites\WordPress' -name Bindings -value @{protocol='http';bindingInformation='*:80:wordpress.dev'}"

  # FastCGI.
  - appcmd set config -section:anonymousAuthentication /username:"" --password
  - appcmd set config /section:system.webServer/fastCGI /+[fullPath='C:\tools\php\php-cgi.exe']
  - appcmd set config /section:system.webServer/handlers /+[name='PHP-FastCGI',path='*.php',verb='*',modules='FastCgiModule',scriptProcessor='C:\tools\php\php-cgi.exe',resourceType='Either']

  - iisreset
  - NET START W3SVC

  # Check it works.
  - powershell -command "wget http://wordpress.dev"

test_script:
  - cd c:\projects\behat
  - vendor\bin\behat --tags="~@javascript" --format=progress --config bin\travis\behat.yml
